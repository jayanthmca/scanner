import socket
import concurrent.futures
import re
import platform
from datetime import datetime

TARGET = "127.0.0.1"   # CHANGE ONLY IN LAB
PORT_RANGE = range(1, 1025)
TIMEOUT = 1
MAX_THREADS = 100

open_ports = []

COMMON_SERVICES = {
    21: "FTP",
    22: "SSH",
    23: "TELNET",
    25: "SMTP",
    53: "DNS",
    80: "HTTP",
    110: "POP3",
    135: "RPC",
    139: "NetBIOS",
    143: "IMAP",
    443: "HTTPS",
    445: "SMB",
    3389: "RDP"
}

def identify_service(port):
    return COMMON_SERVICES.get(port, "Unknown")

def extract_version(banner):
    if not banner:
        return "Unknown"
    match = re.search(r"\d+\.\d+(\.\d+)?", banner)
    return match.group(0) if match else "Unknown"

def scan_port(port):
    try:
        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
            s.settimeout(TIMEOUT)
            result = s.connect_ex((TARGET, port))
            if result == 0:
                banner = ""
                try:
                    s.sendall(b"\r\n")
                    banner = s.recv(1024).decode(errors="ignore").strip()
                except:
                    banner = ""

                service = identify_service(port)
                version = extract_version(banner)

                open_ports.append({
                    "port": port,
                    "service": service,
                    "version": version,
                    "banner": banner if banner else "No banner"
                })
    except:
        pass

def run_scan():
    print("=" * 60)
    print(f"[+] Target: {TARGET}")
    print(f"[+] Time: {datetime.now()}")
    print(f"[+] Host Platform: {platform.system()} {platform.release()}")
    print("=" * 60)

    with concurrent.futures.ThreadPoolExecutor(max_workers=MAX_THREADS) as executor:
        executor.map(scan_port, PORT_RANGE)

    print("\n[+] Scan Complete\n")

    if open_ports:
        for entry in sorted(open_ports, key=lambda x: x["port"]):
            print(f"[OPEN] Port {entry['port']} | "
                  f"{entry['service']} | "
                  f"Version: {entry['version']}")
    else:
        print("No open ports detected.")

    print("\n[+] Summary")
    print(f"Total Open Ports: {len(open_ports)}")

if __name__ == "__main__":
    run_scan()